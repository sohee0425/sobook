<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

<th:block layout:fragment="css">
  <style>
    /* 별평점 기본효과 스타일 */
    p#star_rev_score a.rev_score {
      font-size: 22px;
      text-decoration: none;
      color: lightgray;
    }

    /* 별평점에 클릭했을 경우 선택자 */
    p#star_rev_score a.rev_score.on {
      color: goldenrod;
    }

  </style>

    <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">

</th:block>

<th:block layout:fragment="script">

<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
  <script>
    $( function() {
      $( "#tabs" ).tabs();
    } );
    </script>
    <script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>
    <script id="templateReply" type="text/x-handlebars-template">
      <table class="table" id="reviewTable">
        <tbody>
          {{#each .}}
          <tr>
            <td>{{rev_code}}</td>
            <td>{{mem_id}}</td>
            <td>{{rev_content}}</td>
            <td>{{displayStar rev_score}}</td>
            <td>{{convertDate rev_date}}</td>
            <td>
              {{authControlView mem_id rev_code}}
            </td>
          </tr>
          {{/each}}
        </tbody>
      </table>
    </script>

    <script th:inline="javascript">
      // 핸들바 템플릿에서 사용자정의 함수 : 후기작성시간 포맷(형식)
      Handlebars.registerHelper("convertDate", function(reviewDate) {
        const date = new Date(reviewDate);
  
        let month = (date.getMonth()+1 < 10 ? "0" + (date.getMonth()+1) : date.getMonth()+1);
        let day = (date.getDate() < 10 ? "0" + (date.getDate()) : date.getDate());
        let hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
        let minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
        let second = date.getSeconds() <script 10 ? "0" + date.getSeconds() : date.getSeconds();
        return date.getFullYear() + "/" + month + "/" + day + " " + hour + ":" + minute + ":" + second;
      });

      // 핸들바 템플릿 사용자 정의 함수- 로그인 사용자와 후기 작성자가 같을 때만 수정,삭제 버튼 표시하기
      Handlebars.registerHelper("authControlView", function(mem_id, rev_code) {
        console.log("작성자", mem_id);
        console.log("후기번호", rev_code)
        // 로그인 사용자는 세션으로 확인한다.
        let memberVo = [[${session.login_auth}]];

        let loginId = "";

        if(memberVo !== null) { // 로그인
          loginId = [[${session.login_auth == null? '' : session.login_auth.mem_id}]];
        }

        console.log("아이디", loginId);

        let str = "";

        // 로그인상태이며 로그인=후기아이디 일치 시
        if(memberVo !== null && loginId == mem_id) {
          str += `<button type="button" name="delete" class="btn btn-outline-danger btn-sm" data-rev_code="${rev_code}">delete</button>`;
          str += `<button type="button" name="edit" class="btn btn-outline-info btn-sm" data-rev_code="${rev_code}">edit</button>`;
          str += `<button type="button" name="update" class="btn btn-outline-info btn-sm" data-rev_code="${rev_code}">update</button>`;

          return new Handlebars.SafeString(str);
        }else {
          return str;
        }
      });

      // 평점 별표시 핸들바 사용자정의 함수
      Handlebars.registerHelper("displayStar", function(rating) {
        let star = "";
        switch(rating) {
          case 1:
            star = "★☆☆☆☆";
            break;
          case 2:
            star = "★★☆☆☆";
            break;
          case 3:
            star = "★★★☆☆";
            break;
          case 4:
            star = "★★★★☆";
            break;
          case 5:
            star = "★★★★★";
            break;
        }
        return star;
      });
    </script>  
</th:block>

<th:block layout:fragment="content">

<div class="row">
    <div class="col text-center mb-3 mt-3">
      <h3 th:utext="${cate_name}"></h3>
    </div>
  </div>
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">        
    <div class="col-6">
      <img style="width: 100%;height: 225px;" th:src="${'/product/image_display?dateFolderName=' + productVo.pro_up_folder + '&fileName=' + productVo.pro_img}">
    </div>
    <div class="col-6">
      <h5 th:text="${productVo.pro_name}"></h5>
      <div class="mt-3">가격 <span>[[${#numbers.formatInteger(productVo.pro_price, 3, 'COMMA') + '원'}]]</span></div>
      <div class="mt-3">할인율 <span th:text="${productVo.pro_discount}"></span></div>
      <div class="mt-3">제조사 <span th:text="${productVo.pro_publisher}"></span></div>
      <div class="mt-3">수량 <input type="number" value="1" id="cart_amount"></div>
      <div class="d-flex justify-content-between  mt-5">
        <div class="btn-group">
          <button type="button" class="btn btn-outline-success" id="btn_buy_add">주문하기</button>
          <button type="button" class="btn btn-outline-success" id="btn_cart_add">장바구니</button>
          <button type="button" class="btn btn-outline-success" id="btn_wish_add">찜</button>
        </div>
        <small class="text-body-secondary">상품후기 : [[${productVo.pro_review}]]</small>
      </div>
    </div>
  </div>
  
  <div class="row mt-5">
    <div id="tabs">
      <ul>
        <li><a href="#tabs-1">상세정보</a></li>
        <li><a href="#tabs-2">리뷰</a></li>
        <li><a href="#tabs-3">QnA</a></li>
      </ul>
      <div id="tabs-1">
        <p>상세내용</p>
        <p th:utext="${productVo.pro_content}"></p>
      </div>
      <div id="tabs-2">
        <div class="row mt-3 mb-3">
          <div class="col-10">
            <textarea class="form-control" id="rev_content" rows="3"></textarea>
          </div>
          <div class="col-2">
            <p id="star_rev_score">
              <a class="rev_score" href="#">☆</a>
              <a class="rev_score" href="#">☆</a>
              <a class="rev_score" href="#">☆</a>
              <a class="rev_score" href="#">☆</a>
              <a class="rev_score" href="#">☆</a>
            </p>
            <button type="button" class="btn btn-success mb-2" id="btn_rev_save" th:data-pro_code="${productVo.pro_code}">후기 작성</button>
          </div>
        </div>
        <div class="row">
          <!-- 상품후기 목록 출력 위치-->
          <div class="col" id="reviewList"></div>
        </div>
        <div class="row">
          <!-- 상품후기 페이지 출력 위치-->
           <div class="col" id="reviewPaging"></div>
        </div>
      </div>
      <div id="tabs-3">
        <p>QnA</p>
      </div>
    </div>
  </div>
  <script>

    $(document).ready(function() {

      // 장바구니 클릭이벤트.  id="btn_cart_add"
      $("#btn_cart_add").on("click", function() {
        //console.log("장바구니 클릭");

        $.ajax({
          url: '/cart/cart_add',
          type: 'post',
          data: {pro_code: [[${productVo.pro_code}]], cart_amount : $("#cart_amount").val()},
          dataType: 'text',
          success: function(result) {
            if(result == "success") {
              alert("장바구니에 추가되었습니다.");
              if(confirm("장바구니로 이동하시겠습니까?")) {
                location.href = "/cart/cart_list";
              }
            }
          }
        });
      });

      // 구매 클릭 btn_buy_add
      $("#btn_buy_add").on("click", function() {
        let cart_amount = $("#cart_amount").val();
        let url = `/order/order_info?pro_code=[[${productVo.pro_code}]]&cart_amount=${cart_amount}&type=buy`;

        location.href = url;
      });

      // 상품후기
      let pro_code = [[${productVo.pro_code}]];
      let reviewPage = 1; // 댓글 첫번째 페이지

      // 댓글 데이터 불러올 주소
      let url = "/review/rev_list/" + pro_code + "/" + reviewpage;

      console.log("url", url);

      getPage(url);

      // 스프링에서 댓글, 페이징정보 ajax로 호출하는 함수
      function getPage(url) {

        $("rev_content").val(""); // 후기 지우기
        $("p#star_rev_score a.rev_score").removeClass("on"); // 별점 초기화

        $.getJSON(url, function(data) {
          console.log(data.rev_list);
          console.log(data.pageMaker);

          // 상품후기 목록 출력함수 
          fn_displayReViewData(data.rev_list, $("div#reviewList"), $("#templateReview"));

          // 페이징 출력함수
          fn_displayEwViewPaging(data.pageMaker, $("div#reviewPaging"));
        });
      }

      // 댓글목록출력함수 : 핸들바 템플릿 사용
      function fn_displayReViewData(reviewData, target, template) {
        let templateObj = Handlebars.compile(template.html()); 
        let reviewHtml = templateObj(reviewData);

        target.empty(); // 기존 댓글 목록 제거
        target.append(reviewHtml); // 댓글목록 출력됨

        // update 버튼 숨기기.
        $("table#reviewTable button[name=update]").hide();
      }


      // 페이징출력함수 - 핸들바 템플릿 사용안함.
      function fn_displayReViewPaging(pageData, target) {	

        console.log(pageData);

        let pageStr = '<nav aria-label="Page navigation example">';
          pageStr += '<ul class="pagination">';
        
        
        if(pageData.prev) {
          pageStr += '<li class="page-item"><a class="page-link" href="' + (pageData.startPage -1)  + '">Previous</a></li>';
        }

        for(let i=pageData.startPage; i <= pageData.endPage; i++) {
          let curPageClass = (pageData.cri.page == i) ? 'active' : '';
          pageStr += '<li class="page-item ' + curPageClass + '"><a class="page-link" href="' + i + '">' + i + '</a></li>';
        }


        if(pageData.next) {
          pageStr += '<li class="page-item"><a class="page-link" href="' + (pageData.endPage + 1) + '">Next</a></li>';
        }

        pageStr += '</ul>';
        pageStr += '</nav>';

        console.log(pageStr);

        target.empty();
        target.append(pageStr);
      }

      // 페이지 번호 클릭 설정 reviewPaging
      $("div#reviewPaging").on("click", "li a", function(e) {
        e.preventDefault(); // a태그의 링크기능 제거
        reviewPage = $(this).attr("href"); // 페이지 번호 읽기

        console.log("선택한 페이지 ", replyPage);

        url = "/review/rev_list/" + pro_code + "/" + reviewPage;

        getPage(url);
      });

    }); // ready 끝

  </script>
</th:block>
</html>