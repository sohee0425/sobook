<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layouts/layout}">

    <th:block layout:fragment="css">
        <style>
          /* 별평점 기본효과 스타일 */
          p#star_rev_score a.rev_score {
            font-size: 22px;
            text-decoration: none;
            color: lightgray;
          }
      
          /* 별평점에 클릭했을 경우 선택자 */
          p#star_rev_score a.rev_score.on {
            color: goldenrod;
          }
          @import url("https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css");
      
      
          #tabs ul li {
          background-color: #f8f9fa;
          border: 1px solid #ccc;
          display: inline-block;
          cursor: pointer;
      }
      
      /* 활성화된 탭 스타일 */
      #tabs ul li.ui-tabs-active {
          background-color: black; 
          color: white;
          font-weight: bold;
      }
        </style>
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
      
          <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
      </th:block>

      <th:block layout:fragment="script">
        <script src="https://code.jquery.com/ui/1.14.1/jquery-ui.js"></script>
        <script>
            $( function() {
              $( "#tabs" ).tabs();
            } );
            </script>

<script src="https://cdn.jsdelivr.net/npm/handlebars@latest/dist/handlebars.js"></script>

<script id="review_template" type="text/x-handlebars-template">
    <table id="revtable" class="table" style="text-align: center;">
      <thead>
        <tr>
          <th scope="col">번호</th>
          <th scope="col">내용</th>
          <th scope="col">평점</th>
          <th scope="col">작성자</th>
          <th scope="col">등록일</th>
          <th scope="col">비고</th>
        </tr>
      </thead>
      <tbody>
        {{#each .}} 
          <tr>
            <th scope="row">{{rev_code}}</th>
            <td>{{rev_content}}</td>
            <td>{{displayStar rev_score}}</td>
            <td>{{mbsp_id}}</td>
            <td>{{convertDate rev_date}}</td>
            <td>{{authControlView mbsp_id rev_code}}</td>
          </tr>
          {{#if replies.length}}
          {{#each replies}}
          <tr>
            <td colspan="6">[관리자] 답변글 : {{reply_content}} 작성일 : {{convertDate reply_date}}</td>
          </tr>
            {{/each}}
            {{/if}}
            {{/each}}
      </tbody>
    </table>
  </script>

  <script id="qna_template" type="text/x-handlebars-template">
    <table class="table" id="qnatable">
      {{#each .}}
      <div class="accordion accordion-flush" id="accordionFlushExample">
        <div class="accordion-item">
          <p class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseOne-{{qna_code}}" aria-expanded="false" aria-controls="flush-collapseOne">
              QnA {{qna_code}} : {{qna_title}}
            </button>
          </p>
          <div id="flush-collapseOne-{{qna_code}}" class="accordion-collapse collapse" data-bs-parent="#accordionFlushExample">
            <div class="accordion-body">
              <hr> 작성자 : {{mem_id}} <br>
              문의 내용 : {{qna_content}} <hr>
              문의 작성일 :  {{convertDate qna_date}} <hr>
              비고 :  {{authControlView mem_id qna_code}} <hr>
            </div>
  
            <!-- 답변이 있을 때만 출력하는 부분 -->
            {{#if answer.length}} 
              {{#each answer}} 
                <div class="accordion-body">
                  <strong>QnA 답변</strong> <br>
                  작성자 : {{manager_id}} <br>
                  답변 제목 : {{ans_title}} <br>
                  답변 내용 : {{ans_content}} <hr>
                  답변 작성일 :  {{convertDate ans_date}} <hr>
                </div>
              {{/each}} <!-- answer 반복문 끝 -->
            {{else}} 
            <p><em>아직 답변이 없습니다.</em></p>
            {{/if}} 
          </div>
        </div>
      </div>
      {{/each}} <!-- qna 반복문 끝 -->
    </table>
  </script>
      </th:block>
  
   

<body>
  <th:block layout:fragment = "content">
    <div class="container" style="padding-top: 50px;">
        <div class="row">
            <div class="col-12 col-sm-6">
              <h3 th:utext="${cate_name}"></h3>
              <div class="col-12">
                <img style="width: 60%;height: 350px;" th:src="${'/product/image_display?dateFolderName=' + productVo.pro_up_folder + '&fileName=' + productVo.pro_img}">
              </div>
            </div>
            <div class="col-12 col-sm-6">
              <h3 class="mt-3" th:text="${productVo.pro_name}">제품명</h3>
              <small class="text-body-secondary">상품 리뷰 : <span id="review_count" th:text="${productVo.pro_review}"></span></small>
              <hr>
        
              <div class="bg-gray py-2 px-3 mt-4">
              <h5 class="mb-0">
                <div class="mt-3">가격 | <span>[[${#numbers.formatInteger(productVo.pro_price, 3, 'COMMA') + '원'}]]</span></div>
              </h5>
              <h5 class="mb-0">
                <div class="mt-3">할인율 | <span th:text="${productVo.pro_discount}"></span></div>
              <h5 class="mb-0">
                <div class="mt-3">출판사 | <span th:text="${productVo.pro_publisher}"></span></div>
              </h5>
              <h5 class="mb-0">
                <div class="mt-3">수량 | <input type="number" value="1" id="cart_amount"></div>
              </h5>
            
              <div class="mt-4">
                <button type="button" class="btn btn-dark btn-lg btn-flat" id="btn_buy_add">주문하기</button>
                <button type="button" class="btn btn-dark btn-lg btn-flat" id="btn_cart_add">장바구니</button>
                <button type="button" class="btn btn-outline-dark btn-lg btn-flat" id="btn_wish_add"><i class="bi bi-heart-fill"></i></button>
              </div>
        
            </div>
            </div>
          </div>
        
    </div>

    <div class="container">
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-header">
              <div id="nav" class="d-flex selectnav justify-content-between">
                <div class="col-4">
                  <a href="#pro_detailinfo">상품상세정보</a>
                </div>
                <div class="col-4">
                  <a href="#pro_review">상품구매후기</a>
                </div>
                <div class="col-4">
                  <a href="#pro_qna">Q&A</a>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div id="pro_detailinfo" class="section">
                <p th:utext="${productVo.pro_content}"></p>
              </div>
              <div id="pro_review">
                <div class="text-center">
                  <h3 class="pb-4 mb-4">상품구매후기</h3>
                </div>
                <div id="review_list"><!-- 상품구매후기 출력 위치 --></div>
                <button type="button" class="btn btn-success float-right" id="btn_review_modal" data-toggle="modal">상품후기 작성</button>
                <div id="review_paging"><!-- 페이징 출력 위치 --></div>
              </div>
              <div id="pro_qna" class="section">
                <h3 class="pb-4 mb-4 text-center">Q&A</h3>
                <div id="qna_list"><!-- 상품질문 출력 위치 --></div>
                <button type="button" id="btn_qna_modal" class="btn btn-success float-right">상품문의 작성</button>
                <div id="qna_paging"><!-- 페이징 출력 위치 --></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 상품 구매 후기 등록/수정 모달 -->
    <div class="modal fade" id="review_modal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="staticBackdropLabel">상품 구매 후기</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form>
              <div class="form-group">
                <label for="message-text" class="col-form-label">번호</label>
                <input type="hidden" class="form-control" id="rev_code">
              </div>
              <div class="form-group">
                <label for="message-text" class="col-form-label">내용</label>
                <textarea class="form-control" id="rev_content"></textarea>
              </div>
              <div class="form-group">
                <label for="recipient-name" class="col-form-label">평점</label>
                <p id="star_rev_score">
                  <a class="rev_score" href="#">☆</a>
                  <a class="rev_score" href="#">☆</a>
                  <a class="rev_score" href="#">☆</a>
                  <a class="rev_score" href="#">☆</a>
                  <a class="rev_score" href="#">☆</a>
                </p>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
		        <button type="button" id="btn_review_save" class="btn btn-primary" th:data-pro_code="${productVo.pro_code}">저장</button>
		        <button type="button" id="btn_review_modify" class="btn btn-primary" th:data-pro_code="${productVo.pro_code}">수정</button>
          </div>
        </div>
      </div>
    </div>

        <!-- 상품 문의(Q&A) 등록/수정 모달 -->
        <div class="modal fade" id="qna_modal" data-backdrop="static" data-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">상품 문의</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
              <div class="modal-body">
                <form>
                  <div class="form-group">
                    <label for="qna_title-text" class="col-form-label">제목</label>
                    <input type="text" class="form-control" id="qna_title" />                   
                    <input type="hidden" class="form-control" id="qna_code">
                  </div>
                  <div class="form-group">
                    <label for="qna_content" class="col-form-label">내용</label>
                    <textarea class="form-control" id="qna_content"></textarea>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
                <button type="button" id="btn_qna_save" class="btn btn-primary" th:data-pro_code="${productVo.pro_code}">저장</button>
                <button type="button" id="btn_qna_modify" class="btn btn-primary" th:data-qno="${qno}">수정</button>
              </div>
            </div>
          </div>
        </div>
  </th:block>


  <th:block layout:fragment = "script">
    <script th:inline="javascript">
      $(document).ready(function() {
        // 네비게이션 링크 클릭 이벤트 처리
        $("div.selectnav a").on("click", function(e) {
          e.preventDefault();

          // 이동할 섹션의 id를 가져오기
          let targetId = $(this).attr("href");

          // 해당 섹션으로 부드럽게 스크롤 이동W
          $("html, body").animate({scrollTop: $(targetId).offset().top}, 500); // 500ms 동안 애니메이션
        });


        $("#btn_wish_add").on("click", function () {
        console.log("찜 클릭");

        $.ajax({
          url: '/wish/wish_add',
          type: 'post',
          data: { pro_code: [[${productVo.pro_code}]] },
          dataType: 'text',
          success: function(result) {
            if (result === "success") {
              alert("찜 추가되었습니다.");
              if (confirm("찜 목록으로 이동하시겠습니까?")) {
                location.href = '/wish/wish_list';
              }
            }
          },
          beforeSend: function(xhr) {
            xhr.setRequestHeader("AJAX", "true");
          },
          error: function(xhr, status, error) {
            console.log(xhr);

            if (xhr.status === 401) { // 로그인 필요
              alert("로그인이 필요한 기능입니다.");
              location.href = "/member/login";
            } else {
              alert("이미 찜 목록에 추가한 상품입니다.");
              if(confirm("찜 목록으로 이동하시겠습니까?")) {
                location.href = '/wish/wish_list';
              }
            }
          }
        });
      });


      // 장바구니 클릭이벤트.  id="btn_cart_add"
      $("#btn_cart_add").on("click", function() {
        console.log("장바구니 클릭");

        $.ajax({
          url: '/cart/cart_add',
          type: 'post',
          data: {pro_code: [[${productVo.pro_code}]], cart_amount : $("#cart_amount").val()},
          dataType: 'text',
          success: function(result) {
            if(result == "success") {
              alert("장바구니에 추가되었습니다.");
              if(confirm("장바구니로 이동하시겠습니까?")) {
                location.href = "/cart/cart_list";
              }
            }
          },
          beforeSend : function(xhr) {
            xhr.setRequestHeader("AJAX", "true");
          },
          error : function(xhr, status, error) {
            console.log(xhr);
            alert("로그인이 필요한 기능입니다.");
            location.href = "/member/login";
          }
        });
      });

      // 구매 클릭 btn_buy_add
      $("#btn_buy_add").on("click", function() {
        let cart_amount = $("#cart_amount").val();
        let url = `/order/order_info?pro_code=[[${productVo.pro_code}]]&cart_amount=${cart_amount}&type=buy`;

        location.href = url;
      });
        


        // 상품 후기와 페이징 정보를 호출하는 작업
        let reviewPage = 1;
        let url = "/review/rev_list/" + [[${productVo.pro_code}]] + "/" + reviewPage;
        console.log("상품후기 주소", url);

        // console.log(url);
        getReviewList(url);

        function getReviewList(url) {
          $.getJSON(url, function(reviewlist) {
            // console.log("reviewlist", reviewlist.revlist);
            //console.log("reviewlist", reviewlist.pageMaker);
            print_reviewlist(reviewlist.revlist, $("#review_list"), $("#review_template"));
            print_paging(reviewlist.pageMaker, $("#review_paging"));
          });
        }

        // 1) 상품구매 후기 UI : Handlebars 템플릿 이용
        let print_reviewlist = function(reviewData, target, template) {
          let templateObj = Handlebars.compile(template.html()); // 템플릿 문법 검사 및 참조
          let reviewHtml = templateObj(reviewData);
          target.children().remove();
          target.append(reviewHtml);
        }

        // 2) 페이징 UI : 로직으로 작업
        let print_paging = function(pageData, target) {
          let str = `<nav aria-label="Page navigation">`;
              str += `<ul class="pagination">`;

          // [Previous] 표시 여부
          if(pageData.prev) {
              str += `<li class="page-item">`;
              str += `<a th:href="${pageData.startPage - 1}" class="page-link movepage">Previous</a>`;
              str += `</li>`;
          }

          // 페이지 번호 표시
          for(let i = pageData.startPage; i <= pageData.endPage; i++) {
            let className = pageData.cri.pageNum == i ? 'active' : '';
            str += `<li class="page-item ${className}" aria-current="page">`;
            str += `<a class="page-link movepage" th:href="${i}">${i}</a>`;
            str += `</li>`;
          }

          // [Next] 표시 여부
          if(pageData.next) {
            str += `<li class="page-item">`;
            str += `<a th:href="${pageData.endPage + 1}" class="page-link movepage">Next</a>`;
            str += `</li>`;
          }

            str += `</ul></nav>`;
          target.html(str);
        }


        // 페이징 클릭 이벤트
        $("#review_paging").on("click", "nav ul.pagination a", function(e) {
          e.preventDefault();
          reviewPage = $(this).attr("th:href"); // 선택한 페이지 번호
          url = "/review/rev_list/" + [[${productVo.pro_code}]] + "/" + reviewPage;

          getReviewList(url);
        });


        // 핸들바 함수 : 상품평점
        Handlebars.registerHelper("displayStar", function(rating) {
          let star = "";
          switch(rating) {
            case 1 :
              star = "★☆☆☆☆";
              break;
            case 2 :
              star = "★★☆☆☆";
              break;
            case 3 :
              star = "★★★☆☆";
              break;
            case 4 :
              star = "★★★★☆";
              break;
            case 5 :
              star = "★★★★★";
              break;
          }
          return star;
        });

        // 핸들바 함수 : 날짜 포맷
        Handlebars.registerHelper("convertDate", function(rev_date) {
          const dates = new Date(rev_regdate);
          let year = dates.getFullYear();
          let month = dates.getMonth() + 1;
          let date = dates.getDate();
          let hour = dates.getHours();
          let minute = dates.getMinutes();

          return `${year}/${month}/${date} ${hour} : ${minute}`;
        });

        // 핸들바 함수 : 후기 작성자와 로그인된 사용자 일치 시 수정, 삭제 버튼 출력
        Handlebars.registerHelper("authControlView", function(mbsp_id, rev_code) {
          // 로그인 하지 않은 상태로 직접 접근이 되지 않음.

          // 서버에서 가져오는 문법은 JS문법보다 먼저 실행됨.
          // 타임리프 주석
          //  1) 타임리프 파서 주석 <!--/* [[${data}]] */--> 웹페이지 및 소스코드 출력 x
          //  2) 타임리프 프로토타입 주석 <!--/*/ [[${data}]] /*/--> 웹페이지 및 소스코드 출력 x, 서버에서 랜더링된 값이 들어올 경우만 소스코드 상 출력됨.
          let memberVo = [[${session.login_auth}]];
          let loginId = "";
          if(memberVo != null) {
            loginId = [[${session.login_auth == null ? "" : session.login_auth.mem_id}]];
          }
          console.log(loginId);

          let str = "";
          if(memberVo != null && loginId == mem_id) {
            str += `<button type="button" name="btn_review_edit" class="btn btn-link" data-rev_code="${rev_code}">수정</button>`;
    				str += `<button type="button" name="btn_review_delete" class="btn btn-link" data-rev_code="${rev_code}">삭제</button>`;
            
            return new Handlebars.SafeString(str); // .SafeString() : HTML을 적용해서 리턴하고 싶을 경우 사용
          }else {
            return "";
          }
        });

        // 상품구매후기 클릭(modal) 
        $("#btn_review_modal").on("click", function() {
          $("#rev_content").val("");
          $("a.rev_score").removeClass("on")

          $("#btn_review_save").show();
          $("#btn_review_modify").hide();
          $("#review_modal").modal('show');
        });

        // 별 평점 클릭
        $("a.rev_score").on("click", function(e) {
          e.preventDefault();
          $(this).parent().children().removeClass("on"); // on선택자 제거
          $(this).addClass("on").prevAll("a").addClass("on"); // 현재선택한 별과 이전별까지 on 선택자 추가
        });

        // 상품구매후기 저장
        $("#btn_review_save").on("click", function() {
          let pro_code = $(this).data("pro_code");
          // console.log("상품코드 ", pro_num);
          let rev_content = $("#rev_content").val();
          let rev_score = 0;

          $("p#star_rev_score a.rev_score").each(function() {
            if($(this).attr("class") == "rev_score on") {
                rev_score += 1;
            }
          });


          if(rev_content == "") {
            alert("내용을 입력하세요.");
            return;
          }

          if(rev_score == 0) {
            alert("별 평점을 선택하세요.");
            return;
          }

          console.log("내용", rev_content);
          console.log("별점", rev_score);

          let review_data = { // Javascript Object 문법
            pro_code : pro_code,
            rev_content : rev_content,
            rev_score : rev_score
          }

          $.ajax({
            url : '/review/review_save',
            headers : {
              "Content-Type" : "application/json", "X-HTTP-Method-Override" : "POST"
            },
            type : 'post',
            data : JSON.stringify(review_data), // JavaScript 값이나 객체를 JSON 문자열로 변환
            dataType : 'text',
            success : function(result) {
              if(result == "success") {
                alert("상품후기가 등록되었습니다.");
                $("#review_modal").modal('hide');
                getReviewList(url);
              }
            }
          });
        });

        // 후기 삭제
        $("div#review_list").on("click", "button[name='btn_review_delete']",  function() {
          if(!confirm("삭제하시겠습니까?")) {
            return;
          }

          let rev_code = $(this).data("rev_code");

          $.ajax({
            url : "/review/review_delete/" + rev_code,
            headers: { // POST 요청을 보내면서 PUT, DELETE 등의 다른 메서드로 처리되도록 하려면 "X-HTTP-Method-Override" 헤더를 사용
					    "Content-Type" : "application/json", "X-HTTP-Method-Override" : "DELETE"
				    },
				    type: 'delete',
				    datatype : 'text',
				    success : function(result) {
					    if(result == "success") {
						    alert("상품후기가 삭제되었습니다.");
						    getReviewList(url);
					    }
				    }
			    });
		    });

        // 후기 수정 폼
        $("div#review_list").on("click", "button[name='btn_review_edit']",  function() {
          let rev_code = $(this).data("rev_code");

          $.ajax({
            url : '/review/review_info/' + rev_code,
            headers: {
              "Content-Type" : "application/json"
            },
            type: 'get',
            datatype : 'json',
            success : function(result) {
              // console.log(result);
              // modal에 상품후기 출력작업
              $("#rev_content").val(result.rev_content);
              $("#rev_code").val(result.rev_code); // <input type="hidden">으로 작업됨.

              let rev_score = result.rev_score;
              $("a.rev_score").removeClass("on"); // on선택자 제거

              $("a.rev_score").each(function(index, item) {
                if(index < rev_score) {
                  $(this).addClass("on");
                }
              });

              // modal 창 보여주기
              $("#btn_review_modify").show();
              $("#btn_review_save").hide();
              $("#review_modal").modal('show');
            }
          });
        });

        // 후기 수정 후 저장
        $("button#btn_review_modify").on("click", function() {
          let pro_code = $(this).data("pro_code");
          // console.log("상품번호", pro_num);
          let rev_code = $("#rev_code").val();
        //   let rev_title = $("#rev_title").val();
          let rev_content = $("#rev_content").val();
          let rev_score = 0; // "on"이 class에 몇 개 존재하는지에 따라 평점을 알 수 있음.

          $("p#star_rev_score a.rev_score").each(function() {
            if($(this).attr("class") == "rev_score on") {
                rev_score += 1;
            }
          });

        //   if(rev_title == "") {
        //     alert("제목을 입력하세요");
        //     $("#rev_title").focus();

        //     return;
        //   } else if(rev_content == "") {
        //       alert("내용을 입력하세요");
        //       $("#rev_content").focus();

        //       return;
        //   } else if(rev_rate == "") {
        //       alert("별 평점을 선택하세요");

        //       return;
        //   }

          let review_data = {
            pro_code : pro_code,
            rev_code : rev_code,
            // rev_title: rev_title,
            rev_content : rev_content,
            rev_score : rev_score
          };

          $.ajax({
            url : '/review/review_modify',
            headers: {
              "Content-Type" : "application/json", "X-HTTP-Method-Override" : "PUT"
            },
            type: 'put',
            data : JSON.stringify(review_data),
            dataType : 'text',
            success : function(result) {
              if(result == "success") {
                alert("상품구매후기가 수정되었습니다.");
                $("#review_modal").modal('hide');
                getReviewList(url);
              }
            }
          });
        });


        // 상품 문의(Qna)와 페이징 정보를 호출하는 작업
        let qnaPage = 1;
        let qnaUrl = "/qna/qna_list/" + [[${productVo.pro_code}]] + "/" + qnaPage;
        console.log("상품문의 주소", qnaUrl);

        // console.log(url);
        getQnaList(qnaUrl);

        function getQnaList(qnaUrl) {
          $.getJSON(qnaUrl, function(qnalist) {
            // console.log("reviewlist", reviewlist.revlist);
            //console.log("reviewlist", reviewlist.pageMaker);
            print_qnalist(qnalist.qna_list, $("#qna_list"), $("#qna_template"));
            print_qnaPaging(qnalist.qna_pageMaker, $("#qna_paging"));
          });
        }

        // 1) 상품구매 후기 UI : Handlebars 템플릿 이용
        let print_qnalist = function(qnaData, target, template) {
          let templateObj = Handlebars.compile(template.html()); // 템플릿 문법 검사 및 참조
          let qnaHtml = templateObj(qnaData);
          target.children().remove();
          target.append(qnaHtml);
        }

        // 2) 페이징 UI : 로직으로 작업
        let print_qnaPaging = function(pageData, target) {
          let str = `<nav aria-label="Page navigation">`;
              str += `<ul class="pagination">`;

          // [Previous] 표시 여부
          if(pageData.prev) {
              str += `<li class="page-item">`;
              str += `<a th:href="${pageData.startPage - 1}" class="page-link movepage">Previous</a>`;
              str += `</li>`;
          }

          // 페이지 번호 표시
          for(let i = pageData.startPage; i <= pageData.endPage; i++) {
            let className = pageData.cri.pageNum == i ? 'active' : '';
            str += `<li class="page-item ${className}" aria-current="page">`;
            str += `<a class="page-link movepage" th:href="${i}">${i}</a>`;
            str += `</li>`;
          }

          // [Next] 표시 여부
          if(pageData.next) {
            str += `<li class="page-item">`;
            str += `<a th:href="${pageData.endPage + 1}" class="page-link movepage">Next</a>`;
            str += `</li>`;
          }

            str += `</ul></nav>`;
          target.html(str);
        }

        // QNA 페이징 클릭 이벤트
        $("#qna_paging").on("click", "nav ul.pagination a", function(e) {
          e.preventDefault();
          qnaPage = $(this).attr("th:href"); // 선택한 페이지 번호
          qnaUrl = "/qna/qna_list" + [[${productVo.pro_code}]] + "/" + qnaPage;

          getQnaList(qnaUrl);
        });

        // 핸들바 함수 : 날짜 포맷
        Handlebars.registerHelper("qnaConvertDate", function(qan_date) {
          const dates = new Date(qan_date);
          console.log("날짜", dates);
          let year = dates.getFullYear();
          let month = dates.getMonth() + 1;
          let date = dates.getDate();
          let hour = dates.getHours();
          let minute = dates.getMinutes();

          return `${year}/${month}/${date} ${hour} : ${minute}`;
        });

        // 핸들바 함수 : 답변여부에 따라 관리자 답변 출력
        // Handlebars.registerHelper("ifAnswerExists", function(reply_content) {
        //   let reply = "";
        //   if(reply_content == null && reply_content != "") {
        //     return reply;
        //   }else {
        //     reply += `<span class="badge badge-pill badge-info" style="font-size: 1em; padding: 0.3em 0.8em;">답변완료</span>${reply_content}`;
        //   }

        //   return new Handlebars.SafeString(reply);
        // });

        // 핸들바 함수 : 문의 작성자와 로그인된 사용자 일치 시 수정, 삭제 버튼 출력
        Handlebars.registerHelper("authQnaControlView", function(mem_id, qna_code) {
          // 로그인 하지 않은 상태로 직접 접근이 되지 않음.
          let memberVo = [[${session.login_auth}]];
          let loginId = "";
          if(memberVo != null) {
            loginId = [[${session.login_auth == null ? "" : session.login_auth.mbsp_id}]];
          }
          console.log(loginId);

          let str = "";
          if(memberVo != null && loginId == mem_id) {
            str += `<button type="button" name="btn_qna_edit" class="btn btn-link" data-qna_code="${qna_code}">수정</button>`;
            str += `<button type="button" name="btn_qna_delete" class="btn btn-link" data-qna_code="${qna_code}">삭제</button>`;
            
            return new Handlebars.SafeString(str); // .SafeString() : HTML을 적용해서 리턴하고 싶을 경우 사용
          }else {
            return "";
          }
        });

        // QNA 상품문의 버튼 클릭(modal) 
        $("#btn_qna_modal").on("click", function() {
          $("#qcontent").val("");

          $("#btn_qna_save").show();
          $("#btn_qna_modify").hide();
          $("#qna_modal").modal('show');
        });

        // QNA 상품문의 저장
        $("#btn_qna_save").on("click", function() {
          let pro_code = $(this).data("pro_code");
          let qna_title = $("#qna_title").val();
          let qna_content = $("#qna_content").val();

          console.log("상품번호", pro_code);
          console.log("제목", qna_title);
          console.log("내용", qna_content);

          let qna_data = { // Javascript Object 문법
            pro_code : pro_code,
            qna_title : qna_title,
            qna_content : qna_content
          }

          $.ajax({
            url : '/qna/qna_write',
            headers : {
              "Content-Type" : "application/json", "X-HTTP-Method-Override" : "POST"
            },
            type : 'post',
            data : JSON.stringify(qna_data), // JavaScript 값이나 객체를 JSON 문자열로 변환
            dataType : 'text',
            success : function(result) {
              if(result == "success") {
                alert("상품문의가 등록되었습니다.");
                $("#qna_modal").modal('hide');
                getQnaList(qnaUrl);
              }
            }
          });
        });

        // QNA 상품문의 삭제
        $("div#qna_list").on("click", "button[name='btn_qna_delete']",  function() {
          if(!confirm("삭제하시겠습니까?")) {
            return;
          }

          let qna_code = $(this).data("qna_code");

          $.ajax({
            url : "/qna/qna_delete/" + qna_code,
            headers: { // POST 요청을 보내면서 PUT, DELETE 등의 다른 메서드로 처리되도록 하려면 "X-HTTP-Method-Override" 헤더를 사용
					    "Content-Type" : "application/json", "X-HTTP-Method-Override" : "DELETE"
				    },
				    type: 'delete',
				    datatype : 'text',
				    success : function(result) {
					    if(result == "success") {
						    alert("Q&A가 삭제되었습니다.");
						    getQnaList(qnaUrl);
					    }
				    }
			    });
		    });

        // QNA 상품문의 수정 폼
        $("div#qna_list").on("click", "button[name='btn_qna_edit']",  function() {
          let qna_code = $(this).data("qna_code");
          

          $.ajax({
            url : '/qna/qna_info/' + qna_code,
            headers: {
              "Content-Type" : "application/json"
            },
            type: 'get',
            datatype : 'json',
            success : function(result) {
              $("#qna_code").val(result.qna_code);
              $("#qna_title").val(result.qna_title);
              $("#qna_content").val(result.qna_content);

              // modal 창 보여주기
              $("#btn_qna_modify").show();
              $("#btn_qna_save").hide();
              $("#qna_modal").modal('show');
            }
          });
        });

        // QNA 상품문의 수정 후 저장
        $("button#btn_qna_modify").on("click", function() {
          let qna_code = $("#qna_code").val();
          let qna_title= $("#qna_title").val();
          let qna_content = $("#qna_content").val();

          if(qna_title == "") {
              alert("제목을 입력하세요");
              $("#qna_title").focus();

              return;
          }

          if(qna_content == "") {
              alert("내용을 입력하세요");
              $("#qna_content").focus();

              return;
          }

          let qna_data = {
            qna_code : qna_code,
            qna_title : qna_title,
            qna_content : qna_content
          };

          $.ajax({
            url : '/qna/qna_modify',
            headers: {
              "Content-Type" : "application/json", "X-HTTP-Method-Override" : "PUT"
            },
            type: 'put',
            data : JSON.stringify(qna_data),
            dataType : 'text',
            success : function(result) {
              if(result == "success") {
                alert("상품문의가 수정되었습니다.");
                $("#qna_modal").modal('hide');
                getQnaList(qnaUrl);
              }
            }
          });
        });



      }); // ready event end
    </script>
  </th:block>
</body>
</html>